  <div id="fileHeader">
    <h1>tree.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>activerecord/lib/active_record/acts/tree.rb
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Tue Mar 27 07:04:38 -0700 2007</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module ActiveRecord
  module Acts #:nodoc:
    module Tree #:nodoc:
      def self.included(base)
        base.extend(ClassMethods)
      end

      # Specify this act if you want to model a tree structure by providing a parent association and a children
      # association. This act requires that you have a foreign key column, which by default is called parent_id.
      #
      #   class Category &lt; ActiveRecord::Base
      #     acts_as_tree :order =&gt; &quot;name&quot;
      #   end
      #
      #   Example:
      #   root
      #    \_ child1
      #         \_ subchild1
      #         \_ subchild2
      #
      #   root      = Category.create(&quot;name&quot; =&gt; &quot;root&quot;)
      #   child1    = root.children.create(&quot;name&quot; =&gt; &quot;child1&quot;)
      #   subchild1 = child1.children.create(&quot;name&quot; =&gt; &quot;subchild1&quot;)
      #
      #   root.parent   # =&gt; nil
      #   child1.parent # =&gt; root
      #   root.children # =&gt; [child1]
      #   root.children.first.children.first # =&gt; subchild1
      #
      # In addition to the parent and children associations, the following instance methods are added to the class
      # after specifying the act:
      # * siblings          : Returns all the children of the parent, excluding the current node ([ subchild2 ] when called from subchild1)
      # * self_and_siblings : Returns all the children of the parent, including the current node ([ subchild1, subchild2 ] when called from subchild1)
      # * ancestors         : Returns all the ancestors of the current node ([child1, root] when called from subchild2)
      # * root              : Returns the root of the current node (root when called from subchild2)
      module ClassMethods
        # Configuration options are:
        #
        # * &lt;tt&gt;foreign_key&lt;/tt&gt; - specifies the column name to use for tracking of the tree (default: parent_id)
        # * &lt;tt&gt;order&lt;/tt&gt; - makes it possible to sort the children according to this SQL snippet.
        # * &lt;tt&gt;counter_cache&lt;/tt&gt; - keeps a count in a children_count column if set to true (default: false).
        def acts_as_tree(options = {})
          configuration = { :foreign_key =&gt; &quot;parent_id&quot;, :order =&gt; nil, :counter_cache =&gt; nil }
          configuration.update(options) if options.is_a?(Hash)

          belongs_to :parent, :class_name =&gt; name, :foreign_key =&gt; configuration[:foreign_key], :counter_cache =&gt; configuration[:counter_cache]
          has_many :children, :class_name =&gt; name, :foreign_key =&gt; configuration[:foreign_key], :order =&gt; configuration[:order], :dependent =&gt; :destroy

          class_eval &lt;&lt;-EOV
            include ActiveRecord::Acts::Tree::InstanceMethods

            def self.roots
              find(:all, :conditions =&gt; &quot;#{configuration[:foreign_key]} IS NULL&quot;, :order =&gt; #{configuration[:order].nil? ? &quot;nil&quot; : %Q{&quot;#{configuration[:order]}&quot;}})
            end

            def self.root
              find(:first, :conditions =&gt; &quot;#{configuration[:foreign_key]} IS NULL&quot;, :order =&gt; #{configuration[:order].nil? ? &quot;nil&quot; : %Q{&quot;#{configuration[:order]}&quot;}})
            end
          EOV
        end
      end

      module InstanceMethods
        # Returns list of ancestors, starting from parent until root.
        #
        #   subchild1.ancestors # =&gt; [child1, root]
        def ancestors
          node, nodes = self, []
          nodes &lt;&lt; node = node.parent while node.parent
          nodes
        end

        # Returns the root node of the tree.
        def root
          node = self
          node = node.parent while node.parent
          node
        end

        # Returns all siblings of the current node.
        #
        #   subchild1.siblings # =&gt; [subchild2]
        def siblings
          self_and_siblings - [self]
        end

        # Returns all siblings and a reference to the current node.
        #
        #   subchild1.self_and_siblings # =&gt; [subchild1, subchild2]
        def self_and_siblings
          parent ? parent.children : self.class.roots
        end
      end
    end
  end
end
</pre>
    </div>