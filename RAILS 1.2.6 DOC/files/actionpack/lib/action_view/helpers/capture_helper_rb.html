  <div id="fileHeader">
    <h1>capture_helper.rb</h1>
    <table class="header-table">
    <tr class="top-aligned-row">
      <td><strong>Path:</strong></td>
      <td>actionpack/lib/action_view/helpers/capture_helper.rb
      </td>
    </tr>
    <tr class="top-aligned-row">
      <td><strong>Last Update:</strong></td>
      <td>Sun Oct 22 16:41:11 -0700 2006</td>
    </tr>
    </table>
  </div>
 <!-- banner header -->

  <div id="bodyContent" >
    <h2>Source Code</h2>
    <pre>module ActionView
  module Helpers
    # Capture lets you extract parts of code which
    # can be used in other points of the template or even layout file.
    #
    # == Capturing a block into an instance variable
    #
    #   &lt;% @script = capture do %&gt;
    #     [some html...]
    #   &lt;% end %&gt;
    #
    # == Add javascript to header using content_for
    #
    # content_for(&quot;name&quot;) is a wrapper for capture which will 
    # make the fragment available by name to a yielding layout or template.
    #
    # layout.rhtml:
    #
    #   &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xml:lang=&quot;en&quot; lang=&quot;en&quot;&gt;
    #   &lt;head&gt;
    #	    &lt;title&gt;layout with js&lt;/title&gt;
    #	    &lt;script type=&quot;text/javascript&quot;&gt;
    #	      &lt;%= yield :script %&gt;
    #     &lt;/script&gt;
    #   &lt;/head&gt;
    #   &lt;body&gt;
    #     &lt;%= yield %&gt;
    #   &lt;/body&gt;
    #   &lt;/html&gt;
    #
    # view.rhtml
    #   
    #   This page shows an alert box!
    #
    #   &lt;% content_for(&quot;script&quot;) do %&gt;
    #     alert('hello world')
    #   &lt;% end %&gt;
    #
    #   Normal view text
    module CaptureHelper
      # Capture allows you to extract a part of the template into an 
      # instance variable. You can use this instance variable anywhere
      # in your templates and even in your layout. 
      # 
      # Example of capture being used in a .rhtml page:
      # 
      #   &lt;% @greeting = capture do %&gt;
      #     Welcome To my shiny new web page!
      #   &lt;% end %&gt;
      #
      # Example of capture being used in a .rxml page:
      # 
      #   @greeting = capture do
      #     'Welcome To my shiny new web page!'
      #   end
      def capture(*args, &amp;block)
        # execute the block
        begin
          buffer = eval(&quot;_erbout&quot;, block.binding)
        rescue
          buffer = nil
        end
        
        if buffer.nil?
          capture_block(*args, &amp;block)
        else
          capture_erb_with_buffer(buffer, *args, &amp;block)
        end
      end
      
      # Calling content_for stores the block of markup for later use.
      # Subsequently, you can make calls to it by name with &lt;tt&gt;yield&lt;/tt&gt;
      # in another template or in the layout. 
      # 
      # Example:
      # 
      #   &lt;% content_for(&quot;header&quot;) do %&gt;
      #     alert('hello world')
      #   &lt;% end %&gt;
      #
      # You can use yield :header anywhere in your templates.
      #
      #   &lt;%= yield :header %&gt;
      #
      # NOTE: Beware that content_for is ignored in caches. So you shouldn't use it
      # for elements that are going to be fragment cached.
      #
      # The deprecated way of accessing a content_for block was to use a instance variable
      # named @@content_for_#{name_of_the_content_block}@. So &lt;tt&gt;&lt;%= content_for('footer') %&gt;&lt;/tt&gt;
      # would be avaiable as &lt;tt&gt;&lt;%= @content_for_footer %&gt;&lt;/tt&gt;. The preferred notation now is
      # &lt;tt&gt;&lt;%= yield :footer %&gt;&lt;/tt&gt;.
      def content_for(name, content = nil, &amp;block)
        eval &quot;@content_for_#{name} = (@content_for_#{name} || '') + capture(&amp;block)&quot;
      end

      private
        def capture_block(*args, &amp;block)
          block.call(*args)
        end
      
        def capture_erb(*args, &amp;block)
          buffer = eval(&quot;_erbout&quot;, block.binding)
          capture_erb_with_buffer(buffer, *args, &amp;block)
        end
      
        def capture_erb_with_buffer(buffer, *args, &amp;block)
          pos = buffer.length
          block.call(*args)
        
          # extract the block 
          data = buffer[pos..-1]
        
          # replace it in the original with empty string
          buffer[pos..-1] = ''
        
          data
        end
      
        def erb_content_for(name, &amp;block)
          eval &quot;@content_for_#{name} = (@content_for_#{name} || '') + capture_erb(&amp;block)&quot;
        end
      
        def block_content_for(name, &amp;block)
          eval &quot;@content_for_#{name} = (@content_for_#{name} || '') + capture_block(&amp;block)&quot;
        end
    end
  end
end
</pre>
    </div>